<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="简介 # 鉴于我所知道的安卓本地快捷存储方案如 SharedPreferences、MMKV、DataStore 都有明显的缺点，未能兼顾好安全、 性能、类型支持、和用法简易方便的程度，个人基于 DataStore 做了一个新的方案 KDataStore。
主要有以下优化：
单例模式 通过委托生成 key。 采用 MutbaleStateFlow 即时观察、同步读写、异步写入磁盘。 备份数据以处理异常。 优化了类型支持, 支持 Kotlin Serializable, 自定义, Nullable 详见 GitHub 仓库(含demo)。
这份中文版本和 Java 支持主要用作初期宣传，在其他作品中并没有考虑。 在支持 IOS 之后会移到 Multiplatform 分组中。 竞品对比 # SharedPreferences MMKV DataStore KDataStore 性能 启动: 2.5ms 读取：耗时可忽略 commit写入: 堵塞2.3ms apply写入: 耗时可忽略，但不知道是否成功异步写入磁盘。 启动: 2.3ms 读写：耗时可忽略 都通过异步，故只测响应: 8.6ms 启动: 13.5ms 文件显著增加时影响不大，亦可先行在 Application中异步启动来解决。 读写：耗时可忽略 类型安全 否 否 是 是 除常见基本类型, String, Set<String> 外的类型支持 Parcelable 自定义"><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="中文"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://shawxingkwok.github.io/ITWorks/docs/android/kdatastore/cn/"><title>中文 | ITWorks</title>
<link rel=manifest href=/ITWorks/manifest.json><link rel=icon href=/ITWorks/favicon.png type=image/x-icon><link rel=stylesheet href=/ITWorks/book.min.33a48f5432973b8ff9a82679d9e45d67f2c15d4399bd2829269455cfe390b5e8.css integrity="sha256-M6SPVDKXO4/5qCZ52eRdZ/LBXUOZvSgpJpRVz+OQteg=" crossorigin=anonymous><script defer src=/ITWorks/flexsearch.min.js></script><script defer src=/ITWorks/en.search.min.ed93006d887fe830a40f983c60c8998c83bbf91c5e1c77f0b572ac20996fdaa9.js integrity="sha256-7ZMAbYh/6DCkD5g8YMiZjIO7+RxeHHfwtXKsIJlv2qk=" crossorigin=anonymous></script><link rel=alternate type=application/rss+xml href=https://shawxingkwok.github.io/ITWorks/docs/android/kdatastore/cn/index.xml title=ITWorks></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/ITWorks/><span>ITWorks</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><span>Multiplatform</span><ul><li><a href=/ITWorks/docs/multiplatform/phone/>Phone</a><ul></ul></li><li><a href=/ITWorks/docs/multiplatform/kt-util/>Kt util</a><ul></ul></li><li><span>MVB</span><ul><li><a href=/ITWorks/docs/multiplatform/mvb/android/>Android</a><ul></ul></li><li><a href=/ITWorks/docs/multiplatform/mvb/proposal/>New UI design proposal</a><ul></ul></li></ul></li></ul></li><li><span>Jvm</span><ul><li><input type=checkbox id=section-f25bd71e28f95a08738fe572911bbd65 class=toggle>
<label for=section-f25bd71e28f95a08738fe572911bbd65 class="flex justify-between"><a role=button>Tracer</a></label><ul><li><a href=/ITWorks/docs/jvm/tracer/setup/>Setup</a><ul></ul></li><li><span>Usage</span><ul><li><a href=/ITWorks/docs/jvm/tracer/usage/annotations/>Annotations</a><ul></ul></li><li><a href=/ITWorks/docs/jvm/tracer/usage/naming-rules/>Naming rules</a><ul></ul></li><li><a href=/ITWorks/docs/jvm/tracer/usage/details/>Details</a><ul></ul></li><li><a href=/ITWorks/docs/jvm/tracer/usage/notes/>Notes</a><ul></ul></li><li><a href=/ITWorks/docs/jvm/tracer/usage/practice/>Practice</a><ul></ul></li><li><a href=/ITWorks/docs/jvm/tracer/usage/test/>Test</a><ul></ul></li></ul></li><li><input type=checkbox id=section-df9c64161b156bfffd3c37819ba87474 class=toggle>
<label for=section-df9c64161b156bfffd3c37819ba87474 class="flex justify-between"><a role=button>Road map</a></label><ul><li><a href=/ITWorks/docs/jvm/tracer/road-map/short-term/>Short term</a><ul></ul></li><li><a href=/ITWorks/docs/jvm/tracer/road-map/long-term/>Long term</a><ul></ul></li><li><a href=/ITWorks/docs/jvm/tracer/road-map/With-kcp/>With Kcp</a><ul></ul></li></ul></li><li><span>Extensions</span><ul><li><a href=/ITWorks/docs/jvm/tracer/extensions/android/>Android-view</a><ul></ul></li></ul></li><li><a href=https://github.com/ShawxingKwok/Tracer target=_blank>Github repo</a><ul></ul></li></ul></li></ul></li><li><span>Android</span><ul><li><a href=/ITWorks/docs/android/util-core/>Util-core</a><ul></ul></li><li><a href=/ITWorks/docs/android/util-view/>Util-view</a><ul></ul></li><li><input type=checkbox id=section-48404a5524d1704bcb4add35c067ddd2 class=toggle checked>
<label for=section-48404a5524d1704bcb4add35c067ddd2 class="flex justify-between"><a role=button>KDataStore</a></label><ul><li><a href=/ITWorks/docs/android/kdatastore/en/>English</a><ul></ul></li><li><a href=/ITWorks/docs/android/kdatastore/cn/ class=active>中文</a><ul></ul></li></ul></li></ul></li></ul><br><ul><li><a href=/ITWorks/post/about/>About</a></li><li><a href=/ITWorks/post/sponsor/>Sponsor</a></li><li><a href=https://github.com/ShawxingKwok target=_blank rel=noopener>Github</a></li><li><a href=mailto:ShawxingKwok@126.com target=_blank rel=noopener>Email</a></li><li><a href=/ITWorks/post/license/>License</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/ITWorks/svg/menu.svg class=book-icon alt=Menu>
</label><strong>中文</strong>
<label for=toc-control><img src=/ITWorks/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#简介>简介</a></li><li><a href=#竞品对比>竞品对比</a></li><li><a href=#基础用法>基础用法</a><ul><li><a href=#建模>建模</a></li><li><a href=#调用>调用</a></li></ul></li><li><a href=#配置>配置</a><ul><li><a href=#根目录>根目录</a></li><li><a href=#模型模块>模型模块</a></li><li><a href=#调用方>调用方</a></li></ul></li><li><a href=#类型支持>类型支持</a></li><li><a href=#迁移>迁移</a></li><li><a href=#可选参数>可选参数</a></li><li><a href=#重置>重置</a><ul><li><a href=#全部>全部</a></li><li><a href=#局部>局部</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=简介>简介
<a class=anchor href=#%e7%ae%80%e4%bb%8b>#</a></h1><p>鉴于我所知道的安卓本地快捷存储方案如 <code>SharedPreferences</code>、<code>MMKV</code>、<code>DataStore</code> 都有明显的缺点，未能兼顾好安全、
性能、类型支持、和用法简易方便的程度，个人基于 <a href="https://developer.android.com/topic/libraries/architecture/datastore?hl=zh-cn" target=_blank>DataStore</a>
做了一个新的方案 <code>KDataStore</code>。</p><p>主要有以下优化：</p><ul><li>单例模式</li><li>通过委托生成 <code>key</code>。</li><li>采用 <code>MutbaleStateFlow</code> 即时观察、同步读写、异步写入磁盘。</li><li>备份数据以处理异常。</li><li>优化了类型支持, 支持 <code>Kotlin Serializable</code>, 自定义, <code>Nullable</code></li></ul><p>详见 <a href=https://github.com/ShawxingKwok/KDataStore target=_blank>GitHub 仓库</a>(含demo)。</p><blockquote class="book-hint warning">这份中文版本和 <code>Java</code> 支持主要用作初期宣传，在其他作品中并没有考虑。</blockquote><blockquote class="book-hint warning">在支持 <code>IOS</code> 之后会移到 <code>Multiplatform</code> 分组中。</blockquote><h1 id=竞品对比>竞品对比
<a class=anchor href=#%e7%ab%9e%e5%93%81%e5%af%b9%e6%af%94>#</a></h1><table><tr><th></th><th><a href="https://developer.android.com/training/data-storage/shared-preferences?hl=zh-cn" target=_blank>SharedPreferences</a></th><th><a href=https://github.com/Tencent/MMKV/blob/master/README_CN.md target=_blank>MMKV</a></th><th><a href="https://developer.android.com/topic/libraries/architecture/datastore?hl=zh-cn" target=_blank>DataStore</a></th><th>KDataStore</th></tr><tr><td>性能</td><td>启动: 2.5ms<br><br>读取：耗时可忽略<br><br><span style=color:red><code>commit</code>写入: 堵塞2.3ms</span><br><br><code>apply</code>写入: 耗时可忽略，<span style=color:red>但不知道是否成功异步写入磁盘。</span></td><td>启动: 2.3ms<br><br>读写：耗时可忽略</td><td>都通过异步，故只测<span style=color:red>响应: 8.6ms</span></td><td><span style=color:red>启动: 13.5ms</span><br>文件显著增加时影响不大，亦可先行在 <code>Application</code>中异步启动来解决。<br><br>读写：耗时可忽略</td></tr><tr><td>类型安全</td><td>否</td><td>否</td><td><span style=color:green>是</span></td><td><span style=color:green>是</span></td></tr><tr><td>除常见基本类型, String, Set&lt;String> 外的类型支持</td><td></td><td><span style=color:green>Parcelable</span></td><td><span style=color:green>自定义</span><br>但需放在独立的 DataStore 中</td><td><span style=color:green>Kt Serializable (包括常见存储类型）<br><br>自定义</span></td></tr><tr><td>读取异常</td><td colspan=2><span style=color:red>返回空的 HashMap, 即全部采用默认值</span></td><td rowspan=2>自行 catch 处理</td><td><span style=color:green>启用备份文件</span></td></tr><tr><td>写入中遇 IOException</td><td>用未写入该数据的备份文件替换，<span style=color:red>且不再写入该数据。</span><br><br>如用 <code>commit</code>, 可通过返回的 <code>false</code> 获悉</td><td><span style=color:red>仅 <code>catch</code> 不处理</span></td><td><span style=color:green>记录，下次启动时从备份文件中更新</span></td></tr><tr><td>多进程</td><td>自行封装</td><td><span style=color:green>支持</span></td><td rowspan=2>处于 <code>1.1.0-alpha</code> 阶段</td><td rowspan=2>在 <code>DataStore 1.1.0</code> 发布之后</td></tr><tr><td>多平台</td><td><span style=color:red>不支持</span></td><td><span style=color:green>支持</span></td></tr><tr><td>加密</td><td>自行封装</td><td><span style=color:green>支持</span></td><td>自行封装</td><td><span style=color:green>需自选加密协议，实现 <code>cipher</code></span></td></tr><tr><td>额外优点</td><td></td><td><span style=color:green>后台定时异步写入磁盘，ANR前一刻更新的数据不会丢失</span></td><td></td><td><span style=color:green>体积小，jar on Android side 仅 12.6 kb</span></td></tr><tr><td>额外缺点</td><td></td><td><span style=color:red>断电或者系统崩溃后容易丢失很多数据</span></td><td></td><td><span style=color:red>比较新</span><br><br><span style=color:red>建模时只能使用 Kotlin, </span>调用时可以使用 Java。</td></tr></table><p>以上测试结果采用 30 份 String 数据，机型魅族18s,
源码见 <a href=https://github.com/ShawxingKwok/KDataStore target=_blank>KDataStore</a>.benchmark。</p><blockquote class="book-hint warning">关于其他地方的存储方案对比分析，绝大多数都有严重错误。
官网相对准确，但也很片面。如想探究，建议自己测试并查阅源码。</blockquote><h1 id=基础用法>基础用法
<a class=anchor href=#%e5%9f%ba%e7%a1%80%e7%94%a8%e6%b3%95>#</a></h1><video height=200 controls>
<source src=../effect.mov type=video/mp4></video><p>以切换主题的场景为例，使用 <code>KDataStore</code> 存储 <code>Boolean</code> 值代表当前主题。</p><h2 id=建模>建模
<a class=anchor href=#%e5%bb%ba%e6%a8%a1>#</a></h2><p>单独分出一个 <code>Android</code> 模块, 常见命名为 <code>settings</code>。<blockquote class="book-hint info">后续文档中的命名均参考 <code>settings</code>。</blockquote><blockquote class="book-hint info">如果不考虑从 <code>Java</code> 文件中调用，下图中的 <code>@JvmStatic</code> 则是不需要的。</blockquote><div style="border:1px solid #000;padding-left:10px;padding-top:10px;padding-right:10px"><img src=../model.png alt></div><br></p><p>关于 <code>KDSFlow</code><div style="border:1px solid #000;padding-left:10px;padding-top:10px;padding-right:10px"><img src=../kdsFlowExpect.png alt></div></p><p>安卓上的 <code>actual KDSFlow</code> 实现<div style="border:1px solid #000;padding-left:10px;padding-top:10px;padding-right:10px"><img src=../kdsFlowActual.png alt></div></p><h2 id=调用>调用
<a class=anchor href=#%e8%b0%83%e7%94%a8>#</a></h2><p>在其他模块中调用<div class=book-tabs><input type=radio class=toggle name=tabs-Preview id=tabs-Preview-0 checked>
<label for=tabs-Preview-0>view-kt</label><div class="book-tabs-content markdown-inner"><ol><li>在 <code>Activity</code>/<code>BasicActivity</code> 中观察<code>Flow</code>/<code>LiveData</code>，绑定主题。</li><li>选中的 <code>RadioButton</code> 会随用户点击自动变化，根据 <code>isDarkMOde.value</code> 设置起始状态即可，不用绑定。</li><li>在 <code>RadioGroup</code> 监听中更新存值。</li></ol><div style="border:1px solid #000;padding-left:10px;padding-top:10px;padding-right:10px"><img src=../kt_basic_usage.png alt></div><blockquote class="book-hint info">在 <code>Fragment</code> 中观察 <code>Flow</code> 时建议采用
<a href=/ITWorks/docs/android/util-view/#flowcollectonresume target=_blank>collectOnResume</a>。其配置工作在下文有包括。</blockquote></div><input type=radio class=toggle name=tabs-Preview id=tabs-Preview-1>
<label for=tabs-Preview-1>view-java</label><div class="book-tabs-content markdown-inner"><ol><li>在 <code>Activity</code>/<code>BasicActivity</code> 中观察 <code>LiveData</code>，绑定主题。</li><li>选中的 <code>RadioButton</code> 会随用户点击自动变化，根据 <code>isDarkMode().getValue()</code> 设置起始状态即可，不用绑定。</li><li>在 <code>RadioGroup</code> 监听中更新存值。</li></ol><div style="border:1px solid #000;padding-left:10px;padding-top:10px;padding-right:10px"><img src=../java_basic_usage.png alt></div></div><input type=radio class=toggle name=tabs-Preview id=tabs-Preview-2>
<label for=tabs-Preview-2>compose</label><div class="book-tabs-content markdown-inner"><p>将 <code>state</code> 和主题绑定</p><div style="border:1px solid #000;padding-left:10px;padding-top:10px;padding-right:10px"><img src=../composeTheme.png alt></div><p><code>RadioButton</code>处更新存值</p><div style="border:1px solid #000;padding-left:10px;padding-top:10px;padding-right:10px"><img src=../composeRadioButton.png alt></div></div></div></p><h1 id=配置>配置
<a class=anchor href=#%e9%85%8d%e7%bd%ae>#</a></h1><p>配置 <code>build.gradle</code>/<code>build.gradle.kts</code> 如下, 或参考 <a href=https://github.com/ShawxingKwok/KDataStore target=_blank>Github</a> 上的 demo
(其中有使用 <a href=https://developer.android.com/build/migrate-to-catalogs target=_blank>version catalog</a>)。</p><h2 id=根目录>根目录
<a class=anchor href=#%e6%a0%b9%e7%9b%ae%e5%bd%95>#</a></h2><div class=book-tabs><input type=radio class=toggle name="tabs-root plugins" id="tabs-root plugins-0" checked>
<label for="tabs-root plugins-0">Groovy</label><div class="book-tabs-content markdown-inner"><pre tabindex=0><code>plugins{
    ...
    id &#39;org.jetbrains.kotlin.plugin.serialization&#39; version &#34;$version_kt&#34; apply false
}
</code></pre></div><input type=radio class=toggle name="tabs-root plugins" id="tabs-root plugins-1">
<label for="tabs-root plugins-1">Kotlin</label><div class="book-tabs-content markdown-inner"><pre tabindex=0><code>plugins{
    ...
    id (&#34;org.jetbrains.kotlin.plugin.serialization&#34;) version &#34;$version_kt&#34; apply false
}
</code></pre></div></div><h2 id=模型模块>模型模块
<a class=anchor href=#%e6%a8%a1%e5%9e%8b%e6%a8%a1%e5%9d%97>#</a></h2><div class=book-tabs><input type=radio class=toggle name="tabs-settings plugins" id="tabs-settings plugins-0" checked>
<label for="tabs-settings plugins-0">Groovy</label><div class="book-tabs-content markdown-inner"><pre tabindex=0><code>plugins {
    ...
    id &#39;kotlinx-serialization&#39;
}

dependencies {
    ...
    implementation &#39;org.jetbrains.kotlinx:kotlinx-coroutines-core:1.7.1&#39; 
    implementation &#39;org.jetbrains.kotlinx:kotlinx-serialization-json:1.5.1&#39;
    implementation &#39;io.github.shawxingkwok:kt-util:1.0.2&#39;
    implementation &#39;io.github.shawxingkwok:kdatastore:1.0.0&#39;
}
</code></pre></div><input type=radio class=toggle name="tabs-settings plugins" id="tabs-settings plugins-1">
<label for="tabs-settings plugins-1">Kotlin</label><div class="book-tabs-content markdown-inner"><pre tabindex=0><code>plugins {
    ...
    id (&#34;kotlinx-serialization&#34;)
}

dependencies {
    ...
    implementation (&#34;org.jetbrains.kotlinx:kotlinx-serialization-json:1.5.1&#34;)
    implementation (&#34;io.github.shawxingkwok:kt-util:1.0.2&#34;)
    implementation (&#34;io.github.shawxingkwok:kdatastore:1.0.0&#34;)
}
</code></pre></div></div><h2 id=调用方>调用方
<a class=anchor href=#%e8%b0%83%e7%94%a8%e6%96%b9>#</a></h2><div class=book-tabs><input type=radio class=toggle name="tabs-caller side" id="tabs-caller side-0" checked>
<label for="tabs-caller side-0">Groovy</label><div class="book-tabs-content markdown-inner"><div class=book-tabs><input type=radio class=toggle name=tabs-Groovy id=tabs-Groovy-0 checked>
<label for=tabs-Groovy-0>view-kt</label><div class="book-tabs-content markdown-inner"><div class=highlight><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>tasks</span><span class=o>.</span><span class=na>withType</span><span class=o>(</span><span class=n>org</span><span class=o>.</span><span class=na>jetbrains</span><span class=o>.</span><span class=na>kotlin</span><span class=o>.</span><span class=na>gradle</span><span class=o>.</span><span class=na>tasks</span><span class=o>.</span><span class=na>KotlinCompile</span><span class=o>).</span><span class=na>configureEach</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>kotlinOptions</span><span class=o>.</span><span class=na>freeCompilerArgs</span> <span class=o>+=</span> <span class=s2>&#34;-Xcontext-receivers&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dependencies</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>implementation</span> <span class=s1>&#39;io.github.shawxingkwok:android-util-view:1.0.8&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>implementation</span> <span class=s1>&#39;io.github.shawxingkwok:kdatastore:1.0.0&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>implementation</span> <span class=nf>project</span><span class=o>(</span><span class=s1>&#39;:本地模型模块名称&#39;</span><span class=o>)</span> <span class=c1>// 或远程仓库
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></div></div><input type=radio class=toggle name=tabs-Groovy id=tabs-Groovy-1>
<label for=tabs-Groovy-1>view-java / compose</label><div class="book-tabs-content markdown-inner"><div class=highlight><pre tabindex=0 class=chroma><code class=language-groovy data-lang=groovy><span class=line><span class=cl><span class=n>dependencies</span><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=n>implementation</span> <span class=s1>&#39;io.github.shawxingkwok:kdatastore:1.0.0&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>implementation</span> <span class=nf>project</span><span class=o>(</span><span class=s1>&#39;:本地模型模块名称&#39;</span><span class=o>)</span> <span class=c1>// 或远程仓库
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>}</span>
</span></span></code></pre></div></div></div></div><input type=radio class=toggle name="tabs-caller side" id="tabs-caller side-1">
<label for="tabs-caller side-1">Kotlin</label><div class="book-tabs-content markdown-inner"><div class=book-tabs><input type=radio class=toggle name=tabs-Kotlin id=tabs-Kotlin-0 checked>
<label for=tabs-Kotlin-0>view-kt</label><div class="book-tabs-content markdown-inner"><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>tasks</span><span class=p>.</span><span class=n>withType</span><span class=p>&lt;</span><span class=n>org</span><span class=p>.</span><span class=n>jetbrains</span><span class=p>.</span><span class=n>kotlin</span><span class=p>.</span><span class=n>gradle</span><span class=p>.</span><span class=n>tasks</span><span class=p>.</span><span class=n>KotlinCompile</span><span class=p>&gt;().</span><span class=n>configureEach</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>kotlinOptions</span><span class=p>.</span><span class=n>freeCompilerArgs</span> <span class=o>+=</span> <span class=s2>&#34;-Xcontext-receivers&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dependencies</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=n>implementation</span> <span class=p>(</span><span class=s2>&#34;shawxingkwok:android-util-view:1.0.8&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>implementation</span> <span class=p>(</span><span class=s2>&#34;io.github.shawxingkwok:kdatastore:1.0.0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>implementation</span> <span class=p>(</span><span class=n>project</span><span class=p>(</span><span class=s2>&#34;:本地模型模块名称&#34;</span><span class=p>))</span> <span class=c1>// 或远程仓库
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div></div><input type=radio class=toggle name=tabs-Kotlin id=tabs-Kotlin-1>
<label for=tabs-Kotlin-1>view-java / compose</label><div class="book-tabs-content markdown-inner"><div class=highlight><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>dependencies</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>..</span><span class=p>.</span>
</span></span><span class=line><span class=cl>    <span class=n>implementation</span> <span class=p>(</span><span class=s2>&#34;io.github.shawxingkwok:kdatastore:1.0.0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>implementation</span> <span class=p>(</span><span class=n>project</span><span class=p>(</span><span class=s2>&#34;:本地模型模块名称&#34;</span><span class=p>))</span> <span class=c1>// 或远程仓库
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div></div></div></div></div><blockquote class="book-hint warning">如果该调用模块使用了 <a href="https://developer.android.com/topic/libraries/app-startup?hl=zh-cn" target=_blank>startup-runtime</a>,
要注意在 <code>dependencies</code> 中包含 <code>KDataStoreInitializer::class.java</code>。</blockquote><h1 id=类型支持>类型支持
<a class=anchor href=#%e7%b1%bb%e5%9e%8b%e6%94%af%e6%8c%81>#</a></h1><p><a href=https://github.com/Kotlin/kotlinx.serialization/blob/master/docs/basic-serialization.md target=_blank>kotlinx.serialization</a>
用法类似 <code>Java Serializable</code>, 但多平台，且速度快两倍多。
被 <code>Serializable</code> 标记的 <code>class</code>, 基本类型，<code>enum</code>, <code>Pair</code>, <code>IntArray</code>, <code>List</code> 的默认实现等等均可视为 <code>Serializable</code>。</p><div style="border:1px solid #000;padding-left:10px;padding-top:10px;padding-right:10px"><img src=../types.png alt></div><ul><li><code>Non-null</code> 时需声明默认值。</li><li><code>Nullable</code> 时默认值被限制为 <code>null</code>。</li><li>自定义时需实现与 <code>Kt Serializable</code> 之间的相互转换。(<code>convert</code>/<code>recover</code>)</li></ul><blockquote class="book-hint warning"><p>在对象的内部修改并不会触发磁盘更新。</p><div style="border:1px solid #000;padding-left:10px;padding-top:10px;padding-right:10px"><img src=../note_update.png alt></div></blockquote><h1 id=迁移>迁移
<a class=anchor href=#%e8%bf%81%e7%a7%bb>#</a></h1><p>类比下图格式（判断存在 -> 迁移 -> 删除）从其他存储仓库迁移过来。其中的 <code>appContext</code> 源自 <code>KDataStore</code>.</p><p>比如取自 <code>SharedPreferences</code><div style="border:1px solid #000;padding-left:10px;padding-top:10px;padding-right:10px"><img src=../migration.png alt></div><br></p><p>此外内置 <code>delete</code>, <code>exist</code> 两个函数辅助从 <code>KDataStore</code> 迁移到别处。<div class=book-tabs><input type=radio class=toggle name=tabs-exist id=tabs-exist-0 checked>
<label for=tabs-exist-0>Kt</label><div class="book-tabs-content markdown-inner"><div style="border:1px solid #000;padding-left:10px;padding-top:10px;padding-right:10px"><img src=../delete_exist_kt.png alt></div></div><input type=radio class=toggle name=tabs-exist id=tabs-exist-1>
<label for=tabs-exist-1>Java</label><div class="book-tabs-content markdown-inner"><div style="border:1px solid #000;padding-left:10px;padding-top:10px;padding-right:10px"><img src=../delete_exist_java.png alt></div></div></div>警告以防止误用，并无异常风险。</p><h1 id=可选参数>可选参数
<a class=anchor href=#%e5%8f%af%e9%80%89%e5%8f%82%e6%95%b0>#</a></h1><div style="border:1px solid #000;padding-left:10px;padding-top:10px;padding-right:10px"><img src=../args.png alt></div><p><div style="border:1px solid #000;padding-left:10px;padding-top:10px;padding-right:10px"><img src=../cipher.png alt></div>加密部分需从 <code>Java</code> 标准库或其他库中自选加密协议，实现 <code>cipher</code>。</p><blockquote class="book-hint info">加密会将启动时间提升一倍左右。Android 在 api 29 版本引入了沙盒机制，实现了数据隔离，脱离加密也相对安全。</blockquote><h1 id=重置>重置
<a class=anchor href=#%e9%87%8d%e7%bd%ae>#</a></h1><h2 id=全部>全部
<a class=anchor href=#%e5%85%a8%e9%83%a8>#</a></h2><div class=book-tabs><input type=radio class=toggle name=tabs-wholeReset id=tabs-wholeReset-0 checked>
<label for=tabs-wholeReset-0>Kt</label><div class="book-tabs-content markdown-inner"><div style="border:1px solid #000;padding-left:10px;padding-top:10px;padding-right:10px"><img src=../wholeResetKt.png alt></div></div><input type=radio class=toggle name=tabs-wholeReset id=tabs-wholeReset-1>
<label for=tabs-wholeReset-1>Java</label><div class="book-tabs-content markdown-inner"><div style="border:1px solid #000;padding-left:10px;padding-top:10px;padding-right:10px"><img src=../wholeResetJava.png alt></div></div></div><h2 id=局部>局部
<a class=anchor href=#%e5%b1%80%e9%83%a8>#</a></h2><p>比如重置声明过的 <code>isDarkMode</code><div class=book-tabs><input type=radio class=toggle name=tabs-partialReset id=tabs-partialReset-0 checked>
<label for=tabs-partialReset-0>Kt</label><div class="book-tabs-content markdown-inner"><pre tabindex=0><code>Settings.isDarkMode.reset()
</code></pre></div><input type=radio class=toggle name=tabs-partialReset id=tabs-partialReset-1>
<label for=tabs-partialReset-1>Java</label><div class="book-tabs-content markdown-inner"><pre tabindex=0><code>Settings.isDarkMode().reset();
</code></pre></div></div></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/ShawxingKwok/ITWorks/blob/main/content/docs/android/kdatastore/cn/_index.md target=_blank rel=noopener><img src=/ITWorks/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#简介>简介</a></li><li><a href=#竞品对比>竞品对比</a></li><li><a href=#基础用法>基础用法</a><ul><li><a href=#建模>建模</a></li><li><a href=#调用>调用</a></li></ul></li><li><a href=#配置>配置</a><ul><li><a href=#根目录>根目录</a></li><li><a href=#模型模块>模型模块</a></li><li><a href=#调用方>调用方</a></li></ul></li><li><a href=#类型支持>类型支持</a></li><li><a href=#迁移>迁移</a></li><li><a href=#可选参数>可选参数</a></li><li><a href=#重置>重置</a><ul><li><a href=#全部>全部</a></li><li><a href=#局部>局部</a></li></ul></li></ul></nav></div></aside></main></body></html>