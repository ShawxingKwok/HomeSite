## KReadStore

An extended data store with little configuration, easy encryption and extensive supported types.

## 不同存储方案对比
|                     | SharedPreferences                                                    | DataStore                      | MMKV                           | 
|---------------------|----------------------------------------------------------------------|--------------------------------|--------------------------------|
| 机制                  | commit 同步写入 <br/>apply 先写入内存，后异步写入磁盘， 其中的 `fsync()` 仍会有轻度堵塞 UI thread | 异步写入磁盘，通过 Flow 收集              | mmap 原理，先写入系统级别的内存，然后隔一段时间写入磁盘 |
| 读取耗时                | 可忽略                                                                  | 40 μs，一般采取 `Flow.collect` 异步观察 | 可忽略                             |
| 写入耗时                | 800 μs                                                               | 1600 μs                        | 20 μs                          |
| 响应耗时                | 230 ms (commit)<br/>可忽略 (apply)                                      | 3 ms                           | 可忽略                            |
| 读取中遇 IOException    | 返回 empty map                                                         | 自行处理                           |                                |
| 写入中遇 IOException    | commit 返回 false <br/> `apply` 通过事务回退，但此时已经事先写入内存，监听到的是没存进去的值         | 自行处理                           |                                |
| CorruptionException |                                                                      | 不常见，自行处理                       | 断电或者系统崩溃后常见, 无法处理              |
| 多进程共享               | 支持                                                                   | 处于 alpha 阶段                    | 支持                             |

可看出 DataStore 牺牲了性能换取数据安全。但既然响应时间已经做到远低于一帧耗时，且这些数据一般不会频繁刷新，我认为此时安全性更加重要。

在 `DataStore<Preferences>` 的基础上，我封装了一个存储框架，有以下优点
- 微配置
- 可加密
- 多类型
  - `Int`, `Long`, `Float`, `Double`, `Boolean`, `String`, `enum`, `Serializable`
  - 使用 `Kotlin serialization` 的类型
  - 其他类型(需附上与 `Serializable` 的转换)
- 妥善处理了 Exception
  - 写入时一并写入备份文件(另走一线程), 以处理 `CorruptionException` 和读取时的 `IOException` 
  - 写入中对 `IOException` 仅 `catch`, 使无法触发相应的 `collect`(一般都有), 以敦促用户重新更新。

[//]: # ( 如果标记写入失败的 Key 呢)

{{< hint info >}}
这份中文版本主要为初期的宣传考虑，其他作品并不会写中文版本。
{{< /hint >}}